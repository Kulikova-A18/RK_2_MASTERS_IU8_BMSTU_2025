# API для системы поддержки (HelpDesk API)

Этот проект представляет собой REST API, разработанное с использованием Flask, для доступа к данным системы поддержки, хранящимся в базе данных PostgreSQL. API предоставляет информацию о пользователях, сотрудниках, тикетах, комментариях и метриках.

## Структура проекта

*   `main.py`: Основной файл Flask-приложения.
*   `requirements.txt`: Файл с зависимостями Python.
*   `logs/`: Папка для хранения логов приложения (создается автоматически).
*   `README.md`: Этот файл.

## Требования

*   **Python 3.x** (рекомендуется 3.8 или выше)
*   **PostgreSQL** (установленный и запущенный)
*   **pip** (менеджер пакетов Python)

## Установка и настройка

1.  **Клонируйте репозиторий (если применимо) или скачайте `main.py`.**

2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**

    ```bash
    python3 -m venv venv
    source venv/bin/activate  # На Windows: venv\Scripts\activate
    ```

3.  **Установите зависимости Python:**

    ```bash
    pip install psycopg2-binary Flask
    ```
    *(Если у вас возникли ошибки при установке `psycopg2-binary`, как описано ранее, установите системные зависимости: `sudo apt install build-essential python3-dev libpq-dev libblas-dev liblapack-dev` и повторите установку через `pip`.)*

4.  **Настройте PostgreSQL:**
    *   Убедитесь, что PostgreSQL запущен: `sudo systemctl start postgresql` (или аналогичная команда для вашего дистрибутива).
    *   Создайте базу данных и заполните её тестовыми данными, используя скрипт `create_support_db.sh` (из вашего репозитория).
    *   Установите пароль для пользователя `postgres`. Подключитесь к PostgreSQL: `sudo -u postgres psql` и выполните команду: `ALTER USER postgres PASSWORD 'your_secure_password';` (замените `'your_secure_password'` на желаемый пароль). Выйдите из `psql`: `\q`.

5.  **Настройте `main.py`:**
    *   Откройте файл `main.py` в текстовом редакторе.
    *   Найдите строку `DB_PASSWORD = 'new_secure_password'`.
    *   Замените `'new_secure_password'` на **пароль, который вы установили для пользователя `postgres` в шаге 4**.
    *   Сохраните изменения в `main.py`.

## Запуск приложения

1.  Убедитесь, что виртуальное окружение активно (если использовали).
2.  Запустите приложение:

    ```bash
    python3 main.py
    ```
    *(Вам **не нужно** запускать скрипт с `sudo`, если вы указали правильный пароль и настроили аутентификацию PostgreSQL для подключения с вашего обычного пользователя Python-скриптом.)*

3.  Приложение будет доступно по адресу: `http://0.0.0.0:5000`

## Аутентификация

Все эндпоинты API (кроме `/api/v1/health`) требуют аутентификации через параметры запроса:
*   `login`: Имя пользователя (например, `admin`, `manager_it`, `manager_hr`, `analyst`).
*   `code`: Код доступа (например, `admin123`, `it2024`, `hr2024`, `analyst2024`).

## Доступные эндпоинты

Все эндпоинты возвращают данные в формате JSON.

*   **`GET /api/v1/health`**: Проверка состояния API. Не требует аутентификации.
    *   Пример: `curl http://0.0.0.0:5000/api/v1/health`

*   **`GET /api/v1/profile?login=<login>&code=<code>`**: Получить профиль авторизованного пользователя.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/profile?login=admin&code=admin123"`

*   **`GET /api/v1/departments?login=<login>&code=<code>`**: Получить статистику по отделам, к которым есть доступ.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/departments?login=manager_it&code=it2024"`

*   **`GET /api/v1/tickets?login=<login>&code=<code>`**: Получить тикеты, назначенные на авторизованного сотрудника.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/tickets?login=analyst&code=analyst2024"`

*   **`GET /api/v1/tickets/<int:ticket_id>?login=<login>&code=<code>`**: Получить детальную информацию по конкретному тикету.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/tickets/1?login=admin&code=admin123"`

*   **`GET /api/v1/staff?login=<login>&code=<code>`**: Получить список активных сотрудников.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/staff?login=admin&code=admin123"`

*   **`GET /api/v1/metrics?login=<login>&code=<code>`**: Получить персональные и отделские метрики.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/metrics?login=analyst&code=analyst2024"`

*   **`GET /api/v1/timeline?login=<login>&code=<code>&days=<int>`**: Получить таймлайн по тикетам за последние N дней (по умолчанию 30).
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/timeline?login=manager_it&code=it2024&days=14"`

*   **`GET /api/v1/comparison?login=<login>&code=<code>`**: Сравнение производительности пользователя с отделом.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/comparison?login=manager_hr&code=hr2024"`

*   **`GET /api/v1/forecast?login=<login>&code=<code>`**: Прогноз по тикетам и трендовый анализ.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/forecast?login=admin&code=admin123"`

*   **`GET /api/v1/categories?login=<login>&code=<code>`**: Статистика по категориям проблем для авторизованного сотрудника.
    *   Пример: `curl "http://0.0.0.0:5000/api/v1/categories?login=analyst&code=analyst2024"`

## Пользователи по умолчанию

Для аутентификации можно использовать следующие учетные данные:

| Логин         | Пароль          | Роль       | staff_id | Отделы (примеры)                               |
| :------------ | :-------------- | :--------- | :------- | :--------------------------------------------- |
| `admin`       | `admin123`      | `admin`    | 1        | Отдел технической поддержки, Отдел системного администрирования |
| `manager_it`  | `it2024`        | `manager`  | 2        | Отдел технической поддержки                    |
| `manager_hr`  | `hr2024`        | `manager`  | 3        | Отдел разработки и внедрения                   |
| `analyst`     | `analyst2024`   | `analyst`  | 4        | Отдел технической поддержки, Отдел системного администрирования |

## Логирование

Приложение логирует свои действия в файл `logs/api.log` в текущей директории. Файл лога ротируется, когда его размер превышает 10 КБ.

## Важно

*   Пароль для подключения к PostgreSQL (`DB_PASSWORD` в `main.py`) должен совпадать с паролем, установленным для пользователя `postgres`.
*   Приложение настроено на работу только с GET-запросами. Попытка выполнить POST/PUT/DELETE запросы приведет к ошибке 405.
*   Данные для аутентификации (`USERS_DB`) в коде захардкожены. В продакшен-окружении данные пользователей должны храниться в защищенной таблице в базе данных.